# 【逆向】pyc文件

## 概念

`.pyc`文件是Python解释器在执行`.py`源代码文件时自动生成的**字节码文件**。

## **作用**

- **提高执行效率**：避免了重复的编译过程。
- **分发代码**：有时开发者会将 `.pyc` 文件分发给用户，作为一种简单的代码保护（虽然反编译相对容易，但能阻止直接查看源码）。

## 文件结构

### **Magic Number（魔数）**

标识该 `.pyc` 文件是由哪个版本的 Python 生成的。

```c
enum PycMagic {
    MAGIC_1_0 = 0x00999902,
    MAGIC_1_1 = 0x00999903, /* Also covers 1.2 */
    MAGIC_1_3 = 0x0A0D2E89,
    MAGIC_1_4 = 0x0A0D1704,
    MAGIC_1_5 = 0x0A0D4E99,
    MAGIC_1_6 = 0x0A0DC4FC,

    MAGIC_2_0 = 0x0A0DC687,
    MAGIC_2_1 = 0x0A0DEB2A,
    MAGIC_2_2 = 0x0A0DED2D,
    MAGIC_2_3 = 0x0A0DF23B,
    MAGIC_2_4 = 0x0A0DF26D,
    MAGIC_2_5 = 0x0A0DF2B3,
    MAGIC_2_6 = 0x0A0DF2D1,
    MAGIC_2_7 = 0x0A0DF303,

    MAGIC_3_0 = 0x0A0D0C3A,
    MAGIC_3_1 = 0x0A0D0C4E,
    MAGIC_3_2 = 0x0A0D0C6C,
    MAGIC_3_3 = 0x0A0D0C9E,
    MAGIC_3_4 = 0x0A0D0CEE,
    MAGIC_3_5 = 0x0A0D0D16,
    MAGIC_3_5_3 = 0x0A0D0D17,
    MAGIC_3_6 = 0x0A0D0D33,
    MAGIC_3_7 = 0x0A0D0D42,
    MAGIC_3_8 = 0x0A0D0D55,
    MAGIC_3_9 = 0x0A0D0D61,
};
```

在16进制文件编辑器中，也可能是以小端序形式展现的。

### 不同版本比较

| Python 版本范围                              | Magic Number | 保留/填充字段            | 时间戳/哈希字段                | 源文件大小字段       | 总头部长度（字节） | 说明                                                         |
| -------------------------------------------- | ------------ | ------------------------ | ------------------------------ | -------------------- | ------------------ | ------------------------------------------------------------ |
| **< Python 3.3**（如 2.x, 3.0~3.2）          | 4 字节       | 无                       | 4 字节（mtime 时间戳）         | 无                   | **8 字节**         | 仅使用修改时间判断缓存有效性，不校验文件大小。               |
| **Python 3.3 ~ 3.6**（包含 3.3，不包含 3.7） | 4 字节       | 无                       | 8 字节（扩展的时间戳）         | 4 字节（源文件大小） | **16 字节**        | 引入文件大小校验，提高缓存有效性判断的准确性。               |
| **≥ Python 3.7**                             | 4 字节       | 4 字节（保留，通常为 0） | 8 字节（可为时间戳或内容哈希） | 8 字节（源文件大小） | **24 字节**        | 支持基于内容哈希的校验；反编译时前 16 字节（Magic + 保留 + 时间戳/哈希）可整体视为“头部元数据”，后 8 字节大小信息也常需匹配。但如仅用于反编译分析，**前 16 字节中保留字段和时间戳/大小可全填 0**，只要 Magic Number 正确即可被 `marshal` 正确读取核心 code object。 |

## 反编译

安装`uncompyle6`，它是目前最常用、功能强大的 Python `.pyc` 文件反编译工具，可以将编译后的字节码还原为近似的 Python 源代码。

```bash
pip install uncompyle6
```

```bash
uncompyle6 your_file.pyc //会在终端直接打印出反编译后的Python 代码
uncompyle6 your_file.pyc > output.py //反编译并保存到.py 文件
```

